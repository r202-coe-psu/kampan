{% extends '/procurement/base/default-procurement-page.html' %}
{% import '/base/components/paginations/pagination.html' as paginated %}
{% import '/procurement/macros/table.html' as table_macros %}
{% from '/base/components/breadcrumbs.html' import RenderBreadcrumb %}

{% block title %}รายการที่ขอต่ออายุแล้ว{% endblock %}
{% block dashboard_title %}รายการครุภัณฑ์ที่ขอต่ออายุแล้ว{% endblock %}

{% block breadcrumbs %}
{{ RenderBreadcrumb([
("รายการครุภัณฑ์ใกล้หมดอายุ", url_for('procurement.requisitions.index', organization_id=organization.id)),
("รายการที่ขอต่ออายุแล้ว", None)
]) }}
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- ปุ่มสร้างรายการขอจัดซื้อ -->
    <div class="mb-4 flex justify-end">
        <a href="{{ url_for('procurement.requisitions.create_or_edit', organization_id=organization.id) }}"
            class="btn btn-primary">
            <i class="ph ph-plus"></i>
            สร้างรายการขอจัดซื้อ
        </a>
    </div>

    {% macro render_renewal_requested_items_table(requisitions) %}
    <div class="mt-12">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-blue-600 flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="ph ph-arrow-clockwise text-blue-600 text-lg"></i>
                </div>
                รายการที่ขอต่ออายุ
            </h3>
            <div class="bg-blue-50 border border-blue-200 rounded-full px-4 py-2">
                <span class="text-blue-700 font-semibold text-sm">{{ requisitions|length }} รายการ</span>
            </div>
        </div>

        {% if requisitions|length == 0 %}
        <!-- Enhanced Empty State -->
        <div
            class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl border-2 border-dashed border-blue-200 p-12 text-center">
            <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="ph ph-check-circle text-blue-400 text-3xl"></i>
            </div>
            <h4 class="text-lg font-semibold text-blue-700 mb-2">ยังไม่มีรายการที่ขอต่ออายุ</h4>
            <p class="text-blue-600">ยังไม่มีการขอต่ออายุในระบบ</p>
        </div>
        {% else %}
        <!-- Enhanced Table Layout -->
        <div class="bg-white rounded-xl shadow-sm border border-blue-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-blue-200">
                    <thead class="bg-gradient-to-r">
                        <tr>
                            <th class="text-center font-semibold text-base-content text-sm py-4">ลำดับ</th>
                            <th class="font-semibold text-base-content text-sm w-48">เลขที่ใบขอจัดซื้อ</th>
                            <th class="font-semibold text-base-content text-sm w-72">ผู้ขอจัดซื้อ</th>
                            <th class="font-semibold text-base-content text-sm text-center w-48">เหตุผล</th>
                            <th class="font-semibold text-base-content text-sm text-center w-48">วันที่เริ่มต้น</th>
                            <th class="font-semibold text-base-content text-sm text-center w-32">เอกสาร</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100">
                        {% for req in requisitions %}
                        <tr class="hover:bg-blue-50 transition-colors duration-200">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div
                                    class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-sm font-bold">
                                    {{ loop.index }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-semibold text-gray-900">{{ req.requisition_code }}</div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium text-gray-900 max-w-xs truncate"
                                    title="{{ req.purchaser.display_fullname() if req.purchaser }}">
                                    {{ req.purchaser.display_fullname() if req.purchaser else '-' }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-700 max-w-xs truncate" title="{{ req.reason }}">
                                    {{ req.reason or '-' }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center gap-2">
                                    <i class="ph ph-calendar-x text-blue-500"></i>
                                    <span class="text-sm font-medium text-blue-700">
                                        {{ req.start_date.strftime('%d/%m/%Y') if req.start_date }}
                                    </span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                {% if req.tor_document %}
                                <a href="{{ url_for('procurement.requisitions.document', requisition_procurement_id=req.id) }}"
                                    class="btn btn-outline btn-sm text-blue-700 border-blue-300 hover:bg-blue-50"
                                    target="_blank">
                                    <i class="ph ph-file-arrow-down"></i> ดูเอกสาร
                                </a>
                                {% else %}
                                <span class="text-gray-400 text-xs">ไม่มีเอกสาร</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
    {% endmacro %}

    {{ table_macros.render_renewal_requested_items_table(requisitions) }}
</div>
{% endblock %}
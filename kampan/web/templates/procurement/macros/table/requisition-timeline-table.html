{% macro requisition_timeline_table(paginated_requisition_timeline, requisition_timeline_list, current_user, organization, PROGRESS_STATUS_ORDER) %}
    {% if requisition_timeline_list|length == 0 %}
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl border-2 border-dashed border-blue-200 p-12">
            <div class="flex flex-col items-center justify-center text-center">
                <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mb-6 animate-pulse">
                    <i class="ph ph-file-plus text-4xl text-blue-500"></i>
                </div>
                <h4 class="text-xl font-semibold text-blue-700 mb-2">ยังไม่มีรายการที่ขอต่ออายุ</h4>
                <p class="text-blue-600 max-w-md mb-6">เมื่อมีการขอต่ออายุครุภัณฑ์ รายการจะปรากฏที่นี่</p>
            </div>
        </div>
    {% else %}
        <div class="bg-white rounded-xl shadow-sm border border-blue-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-blue-200">
                    <thead>
                        <tr class="text-center font-semibold text-base-content text-sm bg-blue-50">
                            <th class="w-[5%] px-2 py-4"></th>
                            <th class="py-4 w-[15%]">เลขที่</th>
                            <!-- <th class="w-40">วันที่ต้องการใช้งาน</th>
                            <th class="w-32">จำนวนเงินรวม</th>
                            <th class="w-32">แนบเอกสาร</th>
                            <th class="w-24">เอกสาร</th>
                            <th class="w-20">สถานะล่าสุด</th> -->
                            <th class="py-4">ความคืบหน้า</th>
                            {% if current_user.has_organization_roles("admin") %}
                                <th class="py-4 w-[15%]">เปลี่ยนสถานะ</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100">
                        {% for item in paginated_requisition_timeline.items %}
                            {% set latest_progress = item.progress[-1] if item.progress else None %}
                            {% set current_step = PROGRESS_STATUS_ORDER.index(latest_progress.progress_status) + 1 if latest_progress else 0 %}
                            <tr class="{% if item.requisition.status == 'incomplete' %}bg-red-50{% elif item.status == 'complete' %}bg-green-50{% endif %}">
                                <td class="px-2 py-3 whitespace-nowrap text-center">
                                    <button class="toggle-icon-btn bg-transparent border-none cursor-pointer"
                                            onclick="toggleSubtable('{{ item.requisition.id }}')"
                                            title="แสดง/ซ่อนรายละเอียด">
                                        <span id="toggle-icon-{{ item.requisition.id }}" style="font-size:1.2em;">
                                            <i class="ph ph-caret-circle-down"></i>
                                        </span>
                                    </button>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-center">
                                    <div class="text-sm flex items-center gap-1 justify-center">
                                        <i class="ph ph-barcode mr-1"></i>{{ item.requisition.requisition_code }}
                                    </div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-center">
                                    <div class="text-sm flex items-center justify-between gap-4">
                                        <span class="flex items-center justify-baseline whitespace-nowrap">
                                            สถานะปัจจุบัน:
                                            {% if current_step == 0 %}
                                                <span class="text-gray-500">ยังไม่ดำเนินการ</span>
                                            {% else %}
                                                <span class="text-blue-600 font-medium">ขั้นตอนที่ {{ current_step }}</span>
                                            {% endif %}
                                        </span>
                                        <ul class="steps text-xs">
                                            <li class="step {% if current_step >= 1 %}step-primary{% endif %}">1</li>
                                            <li class="step {% if current_step >= 2 %}step-primary{% endif %}">2</li>
                                            <li class="step {% if current_step >= 3 %}step-primary{% endif %}">3</li>
                                            <li class="step {% if current_step >= 4 %}step-primary{% endif %}">4</li>
                                            <li class="step {% if current_step >= 5 %}step-primary{% endif %}">5</li>
                                            <li class="step {% if current_step >= 6 %}step-primary{% endif %}">6</li>
                                            <li class="step {% if current_step >= 7 %}step-primary{% endif %}">7</li>
                                        </ul>
                                    </div>
                                </td>
                                {% if current_user.has_organization_roles("admin") %}
                                    <td class="px-4 py-3 whitespace-nowrap text-center">
                                        <button type="button"
                                                class="btn btn-outline btn-sm text-blue-700 border-blue-300 hover:bg-blue-50"
                                                onclick="document.getElementById('modal-update-{{ item.id }}').showModal();">
                                            <i class="ph ph-arrows-clockwise"></i> อัปเดต
                                        </button>
                                    </td>
                                {% endif %}
                            </tr>
                            <tr id="subtable-{{ item.requisition.id }}" style="display:none;">
                                <td colspan="4" class="px-4 py-2">
                                    <ul class="steps steps-vertical w-full">
                                        <li class="step {% if current_step >= 1 %}step-primary{% endif %}">จัดทำเอกสารขอซื้อ/ขอจ้าง</li>
                                        <li class="step {% if current_step >= 2 %}step-primary{% endif %}">ประสานงานกับร้านค้า/บริษัท</li>
                                        <li class="step {% if current_step >= 3 %}step-primary{% endif %}">ยืนยันการสั่งซื้อ/สั่งจ้าง</li>
                                        <li class="step {% if current_step >= 4 %}step-primary{% endif %}">รอส่งมอบพัสดุ</li>
                                        <li class="step {% if current_step >= 5 %}step-primary{% endif %}">ตรวจรับพัสดุ</li>
                                        <li class="step {% if current_step >= 6 %}step-primary{% endif %}">เบิกจ่าย</li>
                                        <li class="step {% if current_step >= 7 %}step-primary{% endif %}">เสร็จสิ้น</li>
                                    </ul>
                                </td>
                            </tr>
                            <!-- Update modal with correct choices -->
                            {% if current_user.has_organization_roles("admin") %}
                                <dialog id="modal-update-{{ item.id }}" class="modal">
                                    <div class="modal-box">
                                        <h3 class="font-bold text-lg mb-4">อัปเดตความคืบหน้า</h3>
                                        <p class="mb-2">
                                            เลขที่: <span class="font-semibold">{{ item.requisition.requisition_code }}</span>
                                        </p>
                                        <form method="POST"
                                              action="{{ url_for('procurement.requisition_timeline.add_progress', requisition_timeline_id=item.id, organization_id=organization.id) }}">
                                            <div class="form-control w-full">
                                                <label class="label">
                                                    <span class="label-text">เลือกขั้นตอน</span>
                                                </label>
                                                <select name="progress" class="select select-bordered w-full" required>
                                                    <option value="" disabled {% if not latest_progress %}selected{% endif %}>-- เลือกขั้นตอน --</option>
                                                    {% for value, label in [
                                                        ('request_created', 'จัดทำเอกสารขอซื้อ/ขอจ้าง'),
                                                        ('vendor_contacted', 'ประสานงานกับร้านค้า/บริษัท'),
                                                        ('order_confirmed', 'ยืนยันการสั่งซื้อ/สั่งจ้าง'),
                                                        ('awaiting_delivery', 'รอส่งมอบพัสดุ'),
                                                        ('inspection', 'ตรวจรับพัสดุ'),
                                                        ('payment_processed', 'เบิกจ่าย'),
                                                        ('completed', 'เสร็จสิ้น')
                                                        ] %}
                                                        <option value="{{ value }}"
                                                                {% if latest_progress and latest_progress.progress_status == value %}selected{% endif %}>
                                                            {{ loop.index }}. {{ label }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="modal-action">
                                                <button type="button"
                                                        class="btn"
                                                        onclick="document.getElementById('modal-update-{{ item.id }}').close()">
                                                    ยกเลิก
                                                </button>
                                                <button type="submit" class="btn btn-primary">บันทึก</button>
                                            </div>
                                        </form>
                                    </div>
                                    <form method="dialog" class="modal-backdrop">
                                        <button>close</button>
                                    </form>
                                </dialog>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}
{% endmacro %}
<script>

function toggleSubtable(itemId) {
    var subtable = document.getElementById('subtable-' + itemId);
    var icon = document.getElementById('toggle-icon-' + itemId);
    if (subtable.style.display === 'none') {
        subtable.style.display = '';
        icon.innerHTML = '<i class="ph ph-caret-circle-down"></i>';
    } else {
        subtable.style.display = 'none';
        icon.innerHTML = '<i class="ph ph-caret-circle-up"></i>';
    }
}
</script>

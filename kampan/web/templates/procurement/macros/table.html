{% macro render_tor_years_table(tor_years, current_user, organization) %}
{% from '/base/components/dialogs.html' import ModalNegative %}
<table class="table w-full">
    <thead>
        <tr>
            <th>ปีงบประมาณ</th>
            <th>วันเริ่มต้น</th>
            <th>วันสิ้นสุด</th>
            <th class="text-center">Tools</th>
            <th class="text-center">Setting</th>
        </tr>
    </thead>
    <tbody>
        {% for y in tor_years %}
        {% set is_default = current_user.user_setting and current_user.user_setting.tor_year and
        current_user.user_setting.tor_year.id == y.id %}
        <tr class="{% if is_default %}bg-green-50 border-green-200{% else %}hover:bg-base-50{% endif %}">
            <td class="{% if is_default %}font-semibold text-green-800{% endif %}">
                {{ y.year }}
            </td>
            <td class="{% if is_default %}text-green-700{% endif %}">
                {{ y.started_date.strftime('%d/%m/%Y') if y.started_date else '-' }}
            </td>
            <td class="{% if is_default %}text-green-700{% endif %}">
                {{ y.ended_date.strftime('%d/%m/%Y') if y.ended_date else '-' }}
            </td>
            <td class="text-center">
                <ul class="menu menu-horizontal bg-base-200 rounded-box p-1 gap-0.5">
                    <li>
                        <div class="tooltip tooltip-top" data-tip="แก้ไขปีงบประมาณ">
                            <a href="{{ url_for('procurement.tor_years.create_or_edit', tor_year_id=y.id, organization_id=organization.id) }}"
                                class="btn btn-ghost btn-xs btn-square hover:bg-blue-100">
                                <i class="ph ph-pencil-simple-line text-base text-blue-600"></i>
                            </a>
                        </div>
                    </li>
                    <li>
                        <div class="tooltip tooltip-top" data-tip="คัดลอกไปปีถัดไป">
                            <a href="{{ url_for('procurement.tor_years.copy_tor_year', tor_year_id=y.id, organization_id=organization.id) }}"
                                class="btn btn-ghost btn-xs btn-square hover:bg-indigo-100">
                                <i class="ph ph-clipboard-text text-base text-indigo-600"></i>
                            </a>
                        </div>
                    </li>
                    {% if not is_default %}
                    <li>
                        <div class="tooltip tooltip-top" data-tip="ลบปีงบประมาณ">
                            <button onclick="showDeleteModal('{{ y.id }}')"
                                class="btn btn-ghost btn-xs btn-square hover:bg-red-100">
                                <i class="ph ph-trash text-base text-red-600"></i>
                            </button>
                        </div>
                    </li>
                    {% endif %}
                </ul>
            </td>
            <td class="text-center">
                <form method="post"
                    action="{{ url_for('procurement.tor_years.set_default_tor_year', tor_year_id=y.id, organization_id=organization.id) }}">
                    <div class="tooltip"
                        data-tip="{% if is_default %}ปีงบประมาณที่ใช้งานอยู่{% else %}ตั้งเป็นปีงบประมาณเริ่มต้น{% endif %}">
                        <button type="submit"
                            class="btn btn-circle btn-sm {% if is_default %}btn-success{% else %}btn-outline border-green-400 text-green-600 hover:bg-green-100 hover:border-green-600{% endif %}">
                            {% if is_default %}
                            <i class="ph ph-check-circle text-lg"></i>
                            {% else %}
                            <i class="ph ph-circle text-lg"></i>
                            {% endif %}
                        </button>
                    </div>
                </form>
            </td>
        </tr>
        {{ ModalNegative(
        id=y.id,
        header="ลบปีงบประมาณ",
        body="คุณต้องการลบปีงบประมาณ " + y.year + " หรือไม่?<br><small class='text-warning'>หมายเหตุ:
            การลบจะซ่อนข้อมูลโดยไม่ลบออกจากระบบอย่างถาวร</small>",
        cancel="ยกเลิก",
        submit="ยืนยันลบ",
        redirect=url_for('procurement.tor_years.delete', tor_year_id=y.id, organization_id=organization.id)
        ) }}
        {% else %}
        <tr>
            <td colspan="5" class="text-center text-gray-400 py-8">ไม่มีข้อมูลปีงบประมาณ</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script type="text/javascript">
    function showDeleteModal(tor_year_id) {
        const modal = document.querySelector('.modal.' + tor_year_id);
        if (modal) {
            modal.showModal();
        }
    }
</script>
{% endmacro %}

{% macro render_products_table(procurements, current_user, organization, today) %}
<!-- Move all modals outside of table -->
{% for item in procurements %}
<dialog id="modal-{{ item.id }}" class="modal">
    <div class="modal-box max-w-6xl w-11/12">
        <!-- Header with gradient background -->
        <!-- Dynamic Header based on payment status -->
        {% set payment_status = item.get_current_payment_status(today) %}
        {% set header_colors = {
        'paid': 'from-green-500 to-green-600',
        'upcoming': 'from-orange-500 to-orange-600',
        'overdue': 'from-red-500 to-red-600'
        } %}
        {% set header_icons = {
        'paid': 'ph-check-circle',
        'upcoming': 'ph-clock',
        'overdue': 'ph-warning-circle'
        } %}

        <div
            class="bg-gradient-to-r {{ header_colors.get(payment_status, 'from-blue-500 to-blue-600') }} text-white p-6 -m-6 mb-6 rounded-t-lg flex flex-col md:flex-row md:items-center md:justify-between gap-2">
            <div>
                <h3 class="font-bold text-xl flex items-center gap-2">
                    <i class="{{ header_icons.get(payment_status, 'ph-file-text') }} text-2xl"></i>
                    รายละเอียดรายการขอซื้อขอจ้าง
                    {% if payment_status == 'paid' %}
                    <span class="badge badge-success badge-lg ml-2">ชำระครบแล้ว</span>
                    {% elif payment_status == 'overdue' %}
                    <span class="badge badge-error badge-lg ml-2">เลยกำหนด</span>
                    {% elif payment_status == 'upcoming' %}
                    <span class="badge badge-warning badge-lg ml-2">ใกล้ครบกำหนด</span>
                    {% endif %}
                </h3>
                <p class="text-white/80 text-xl mt-1">เลขที่เบิกจ่าย: {{ item.product_number }}</p>
                <p class="text-white/80 text-xl mt-1">รหัสครุภัณฑ์: {{ item.asset_code }}</p>
            </div>
            <form method="dialog" class="mt-2 md:mt-0">
                <button
                    class="btn btn-primary btn-lg bg-white/20 border-white/30 text-white hover:bg-white/30 hover:text-white">
                    <i class="ph ph-x mr-1"></i>
                    ปิด
                </button>
            </form>
        </div>


        <!-- Content organized in cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Image Card (show if image exists) -->
                {% if item.image %}
                <div class="md:col-span-2 card bg-base-100 border border-base-200 shadow-sm">
                    <img src="{{ url_for('procurement.products.image', procurement_id=item.id, filename=item.image.filename if item.image.filename else 'image') }}"
                        alt="รูปภาพประกอบ" class="rounded-lg w-full h-auto object-cover max-h-80 shadow-md mx-auto">
                </div>
                {% endif %}
                <!-- Basic Information Card -->
                <div class="card bg-base-100 border border-base-200 shadow-sm">
                    <div class="card-body p-4">
                        <h4 class="font-bold text-lg text-primary mb-3 flex items-center gap-2">
                            <i class="ph ph-info text-xl"></i>
                            ข้อมูลทั่วไป
                        </h4>
                        <div class="space-y-2 text-sm">
                            <p class="text-base-content/70">ชื่อรายการ</p>
                            <div class="flex justify-between">
                                <p class="font-medium">{{ item.name }}</p>
                            </div>
                            <div class="flex justify-between">
                                <p class="text-base-content/70">ประเภท:</p>
                                <p class="font-medium">{{ item.get_category_display()
                                    }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date & Duration Card -->
                <div class="card bg-base-100 border border-base-200 shadow-sm">
                    <div class="card-body p-4">
                        <h4 class="font-bold text-lg text-primary mb-3 flex items-center gap-2">
                            <i class="ph ph-calendar text-xl"></i>
                            วันที่และระยะเวลา
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-base-content/70">วันที่เริ่มต้น:</span>
                                <span class="font-medium">{{ item.start_date.strftime('%d/%m/%Y') if
                                    item.start_date else '-' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-base-content/70">วันที่สิ้นสุด:</span>
                                <span class="font-medium">{{ item.end_date.strftime('%d/%m/%Y') if item.end_date
                                    else '-' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-base-content/70">ระยะเวลา:</span>
                                <span class="font-medium">
                                    {% if item.duration_months is not none and item.duration_days is not none %}
                                    {{ item.duration_months }} เดือน {{ item.duration_days }} วัน
                                    {% else %}
                                    -
                                    {% endif %}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-base-content/70">จำนวนงวด:</span>
                                <span class="font-medium">{{ item.period }} งวด</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financial Information Card -->
                <div class="card bg-base-100 border border-base-200 shadow-sm">
                    <div class="card-body p-4">
                        <h4 class="font-bold text-lg text-green-700 mb-3 flex items-center gap-2">
                            <i class="ph ph-currency-circle-dollar text-xl"></i>
                            ข้อมูลการเงิน
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-green-600">จำนวนเงินรวม:</span>
                                <span class="font-medium text-green-700">฿{{ "{:,.2f}".format(item.amount)
                                    }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-600">สถานะการจ่าย:</span>
                                <span class="badge badge-success badge-sm">{{
                                    item.get_current_payment_status(today) }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-600">งวดที่จ่ายแล้ว:</span>
                                <span class="font-medium">{{ item.payment_records|length }}/{{ item.period }}
                                    งวด</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Responsible Party Card -->
                <div class="card bg-base-100 border border-base-200 shadow-sm">
                    <div class="card-body p-4">
                        <h4 class="font-bold text-lg text-primary mb-3 flex items-center gap-2">
                            <i class="ph ph-users text-xl"></i>
                            ผู้รับผิดชอบ
                        </h4>
                        <div class="space-y-2 text-sm">
                            <span class="text-base-content/70">บริษัท:</span>
                            <div class="flex justify-between">
                                <span class="font-medium">{{ item.company }}</span>
                            </div>
                            <span class="text-base-content/70">ผู้รับผิดชอบ:</span>
                            <div class="flex flex-col gap-1">
                                {% if item.responsible_by %}
                                <div class="flex flex-wrap gap-1">
                                    {% for u in item.responsible_by %}
                                    <span class="font-medium text-primary inline-block max-w-full truncate">
                                        {{ u.display_user_fullname() }}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card bg-base-100 border border-base-200 shadow-sm">
                <!-- Payment History Section -->
                {% if item.payment_records %}

                <div class="card-body p-4">
                    <h4 class="font-bold text-lg text-primary mb-3 flex items-center gap-2">
                        <i class="ph ph-clock-counter-clockwise text-xl"></i>
                        ประวัติการจ่ายเงิน
                    </h4>
                    <div class="overflow-x-auto">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>งวดที่</th>
                                    <th>วันที่จ่าย</th>
                                    <th>ผู้จ่าย</th>
                                    <th>สถานะ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in item.payment_records %}
                                <tr>
                                    <td class="text-xs">{{ loop.index }}</td>
                                    <td class="text-xs">{{ record.paid_date.strftime('%d/%m/%Y %H:%M') }}</td>
                                    <td class="text-xs">{{ record.paid_by.get_name() if record.paid_by else '-'
                                        }}</td>
                                    <td class="text-xs"><span class="badge badge-success badge-xs">จ่ายแล้ว</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>
                {% endif %}
            </div>
        </div>
    </div>
</dialog>

<!-- Payment Confirmation Modal -->
{% set due_dates = item.get_payment_due_dates() %}
{% set status = item.get_current_payment_status(today) %}
{% set next_idx = item.get_next_payment_index() %}
{% set paid_count = item.payment_records|length %}
{% if status != 'paid' and next_idx < due_dates|length and paid_count < item.period %} <dialog
    class="modal payment_{{ item.id }}">
    <div class="modal-box">
        <div class="text-2xl text-success font-bold">
            ยืนยันการชำระเงิน
        </div>
        <p class="py-4">
            คุณต้องการยืนยันการชำระเงินงวดที่ {{ paid_count + 1 }} สำหรับรายการ "{{ item.name }}" หรือไม่?<br>
            <small class='text-warning'>หมายเหตุ: การยืนยันจะบันทึกข้อมูลการชำระเงินในระบบ</small>
        </p>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">ยกเลิก</button>
            </form>
            <form method="post"
                action="{{ url_for('procurement.products.set_paid', procurement_id=item.id, organization=organization.id) }}">
                <button type="submit" class="btn btn-success">
                    ยืนยันชำระ
                    <i class="ph ph-check"></i>
                </button>
            </form>
        </div>
    </div>
    </dialog>
    {% endif %}
    {% endfor %}
    <table class="table w-full">
        <thead class="bg-base-200/50">
            <tr class="border-none">
                <!-- <th class="text-center font-semibold text-base-content text-sm py-4">ลำดับ</th> -->
                <th class="font-semibold text-base-content text-sm w-48">เลขที่เบิกจ่าย</th>
                <th class="font-semibold text-base-content text-sm w-72">ชื่อรายการ</th>
                <th class="font-semibold text-base-content text-sm text-center w-12">ช่วงเวลา</th>
                <th class="font-semibold text-base-content text-sm text-center w-64">ประเภท</th>
                <th class="font-semibold text-base-content text-sm text-center w-64">ระยะเวลา</th>
                <th class="font-semibold text-base-content text-sm text-center">จำนวนเงิน</th>
                <th class="font-semibold text-base-content text-sm text-center w-32">การจ่ายเงิน</th>
                <th class="font-semibold text-base-content text-sm text-center w-72">ผู้รับผิดชอบ</th>
                <th class="font-semibold text-base-content text-sm text-center w-32">สถานะการต่ออายุ</th>
                <th class="font-semibold text-base-content text-sm text-center w-12">Tools</th>
            </tr>
        </thead>
        <tbody>
            {% for item in procurements %}
            <tr class="hover:bg-base-50">

                <!-- Row Number -->
                <!-- <td class="text-center py-4">
            <div
                class="w-8 h-8 rounded-full bg-primary text-primary-content flex items-center justify-center font-bold text-sm">
                {{ loop.index }}
            </div>
        </td> -->

                <!-- PR Number -->
                <td class="py-4">
                    <div class="flex flex-col">
                        <span class="font-bold text-primary text-base">{{ item.product_number }}</span>
                        <span class="text-s text-base-content/60">รหัสครุภัณฑ์: {{ item.asset_code
                            }}</span>
                    </div>
                </td>

                <!-- Name -->
                <td class="py-4">
                    <div class="font-medium text-base-content text-base">{{ item.name }}</div>
                </td>

                <!-- Range Date -->
                <td class="text-center py-4">
                    <div class="flex flex-col items-center">
                        {% if item.start_date and item.end_date %}
                        <span class="font-bold text-base text-primary">
                            {{ item.start_date.strftime('%d/%m/%Y') }}
                        </span>
                        <span class="text-base text-gray-400">
                            to
                        </span>
                        <span class="font-bold text-base text-error">
                            {{ item.end_date.strftime('%d/%m/%Y') }}
                        </span>
                        {% else %}
                        <span class="text-gray-400">-</span>
                        {% endif %}
                    </div>
                </td>


                <!-- Type -->
                <td class="items-center py-4">
                    <div class="flex flex-col items-center">
                        {% set category_badge = {
                        'ซอฟต์แวร์': 'badge-primary',
                        'ครุภัณฑ์': 'badge-warning',
                        'จ้างเหมาบริการ': 'badge-accent',
                        'อื่นๆ': 'badge-neutral'
                        }.get(item.get_category_display(), 'badge-secondary') %}
                        <div class="badge {{ category_badge }} font-medium text-base px-3 py-1">
                            {{ item.get_category_display() }}
                        </div>
                    </div>
                </td>

                <!-- Period -->
                <td class="text-center py-4">
                    <div class="font-bold text-base text-warning">
                        {% if item.duration_months is not none and item.duration_days is not none %}
                        {{ item.duration_months }} เดือน {{ item.duration_days }} วัน
                        {% endif %}
                    </div>
                </td>

                <!-- Amount -->
                <td class="text-center py-4">
                    <div class="text-lg font-bold text-success">฿{{ "{:,.2f}".format(item.amount) }}</div>
                </td>

                <!-- Payment Status -->
                <td class="text-center py-4">
                    {% set due_dates = item.get_payment_due_dates() %}
                    {% set status = item.get_current_payment_status(today) %}
                    {% set next_idx = item.get_next_payment_index() %}
                    {% set paid_count = item.payment_records|length %}
                    {% set badge_class = {
                    'overdue': 'badge-error',
                    'upcoming': 'badge-warning',
                    'paid': 'badge-success'
                    }.get(status, 'bg-gray-500') %}
                    <div class="flex flex-col items-center">
                        <div class="badge {{ badge_class }} text-white font-medium mb-1">
                            งวด {{ paid_count }}/{{ item.period }}
                        </div>
                        {% if next_idx < due_dates|length %} <div class="badge badge-outline font-medium text-s mt-1">
                            ชำระก่อน {{ due_dates[next_idx].strftime('%d/%m/%Y') }}
                    </div>
                    {% endif %}
                    {% if item.payment_records %}
                    <div class="text-s text-gray-500 mt-1">
                        จ่ายล่าสุด: {{ item.payment_records[-1].paid_date.strftime('%d/%m/%Y %H:%M') }}
                    </div>
                    {% endif %}
                    </div>
                </td>

                <!-- Company -->
                <td class="py-4">
                    <div class="flex flex-col">
                        <span class="font-bold text-base py-1">{{ item.company }}</span>
                        <span class="text-s text-base-content/60 py-1">ผู้รับผิดชอบ:</span>
                        <div class="flex flex-wrap gap-1 py-1">
                            {% if item.responsible_by %}
                            {% for u in item.responsible_by %}
                            <span class="badge badge-outline badge-primary font-medium truncate">
                                {{ u.display_user_fullname() }}
                            </span>
                            {% endfor %}
                            {% else %}
                            <span class="text-gray-400">-</span>
                            {% endif %}
                        </div>
                    </div>
                </td>

                <!-- Renewal Status -->
                <td class="text-center py-4">
                    {% if item.status == "pending" %}
                    <span class="badge badge-warning">รอตรวจสอบ</span>
                    {% elif item.status == "disactive" %}
                    <span class="badge badge-error">หยุดต่ออายุ</span>
                    {% elif item.status == "active" %}
                    <span class="badge badge-success">กำลังใช้งาน</span>
                    {% else %}
                    <span class="badge badge-info">ยื่นขอต่ออายุ</span>
                    {% endif %}
                </td>

                <td class="text-center py-4">
                    <div class="tooltip tooltip-left" data-tip="ดูรายละเอียดรายการ">
                        <button type="button"
                            class="btn btn-outline btn-sm rounded-full border-blue-500 text-blue-600 hover:bg-blue-100 hover:border-blue-700 transition"
                            onclick="document.getElementById('modal-{{ item.id }}').showModal();">
                            <i class="ph ph-magnifying-glass text-lg"></i>
                        </button>
                    </div>
                    {% set due_dates = item.get_payment_due_dates() %}
                    {% set status = item.get_current_payment_status(today) %}
                    {% set next_idx = item.get_next_payment_index() %}
                    {% set paid_count = item.payment_records|length %}
                    {% if status != 'paid' and next_idx < due_dates|length and paid_count < item.period %} <div
                        class="tooltip tooltip-left mt-2" data-tip="ยืนยันชำระงวดที่ {{ paid_count + 1 }}">
                        <button type="button"
                            class="btn btn-outline btn-success btn-sm rounded-full border-green-500 text-green-700 hover:bg-green-100 hover:border-green-700 transition"
                            onclick="showPaymentModal('{{ item.id }}')">
                            <i class="ph ph-check text-lg"></i>
                        </button>
                        </div>
                        {% else %}
                        <div class="tooltip tooltip-left" data-tip="ชำระครบทุกงวดแล้ว">
                            <button type="button" disabled
                                class="btn btn-outline btn-disabled btn-sm rounded-full border-gray-300 text-gray-400 mt-2">
                                <i class="ph ph-check text-lg"></i>
                            </button>
                        </div>
                        {% endif %}
                        <div class="tooltip tooltip-left" data-tip="แก้ไขรูปภาพ">
                            <a href="{{ url_for('procurement.products.edit_image', procurement_id=item.id, organization_id=organization.id) }}"
                                class="btn btn-outline btn-warning btn-sm rounded-full border-yellow-500 text-yellow-700 hover:bg-yellow-100 hover:border-yellow-700 transition mt-2">
                                <i class="ph ph-pencil-simple text-lg"></i>
                            </a>
                        </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="10" class="text-center py-8 text-gray-400">ไม่มีข้อมูล</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script type="text/javascript">
        function showPaymentModal(item_id) {
            const modal = document.querySelector('.modal.payment_' + item_id);
            if (modal) {
                modal.showModal();
            }
        }
    </script>
    {% endmacro %}

    {% macro render_mas_table(mas, organization, budget) %}
    <div class="bg-white border border-gray-200 shadow-sm rounded-lg overflow-hidden">
        <div class="border-b border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-md bg-blue-50 flex items-center justify-center mr-4">
                        <i class="ph ph-folder-open text-blue-700"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">รายการโครงการ MAS</h2>
                        <p class="text-sm text-gray-500">แสดง {{ mas|length }} รายการ</p>
                    </div>
                </div>
                <div>
                    <select class="select select-bordered select-sm border-gray-300 text-gray-700 bg-white"
                        onchange="sortTable(this.value)">
                        <option value="">เรียงตาม</option>
                        <option value="mas_code">รหัส MAS</option>
                        <option value="name">ชื่อโครงการ</option>
                        <option value="budget">งบประมาณ</option>
                        <option value="actual_cost">จ่ายจริง</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="table w-full">
                <thead>
                    <tr class="bg-gray-50 text-gray-700">
                        <th class="font-semibold">รหัส MAS</th>
                        <th class="font-semibold">รายการ</th>
                        <th class="font-semibold">หมวดรายจ่าย</th>
                        <th class="font-semibold text-right">จำนวนเงิน</th>
                        <th class="font-semibold text-right">ประมาณจ่าย</th>
                        <th class="font-semibold text-right">จ่ายจริง</th>
                        <th class="font-semibold text-center">การดำเนินการ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in mas %}
                    {% set usage_percent = ((project.actual_cost or 0) / (project.budget or 1) * 100) %}
                    <tr class="hover:bg-gray-50 border-b border-gray-100">
                        <td class="py-4">
                            <span
                                class="inline-block bg-blue-50 text-blue-800 font-mono text-sm py-1 px-2 rounded border border-blue-100">
                                {{ project.mas_code }}
                            </span>
                        </td>
                        <td>
                            <div class="flex items-center">
                                <div class="flex-shrink-0 mr-3">
                                    <div class="w-10 h-10 rounded-md bg-gray-100 flex items-center justify-center">
                                        <i class="ph ph-file-text text-gray-600"></i>
                                    </div>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900">{{ project.name }}</p>
                                    {% if project.item_description %}
                                    <p class="text-sm text-gray-500 truncate max-w-xs">{{ project.item_description[:50]
                                        }}{{ '...' if project.item_description|length > 50 }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="space-y-1">
                                <div
                                    class="bg-gray-100 text-gray-800 text-xs py-1 px-2 rounded-md inline-flex items-center">
                                    <i class="ph ph-tag-simple mr-1"></i>
                                    {{ project.main_category }}
                                </div>
                            </div>
                        </td>
                        <td class="text-right">
                            <span class="font-medium text-gray-900">฿{{ "{:,.2f}".format(project.amount or 0) }}</span>
                        </td>
                        <td class="text-right">
                            <span class="font-medium text-gray-900">฿{{ "{:,.2f}".format(project.budget or 0) }}</span>
                        </td>
                        <td class="text-right">
                            <span
                                class="font-medium {{ 'text-red-700' if (project.actual_cost or 0) > (project.budget or 0) else 'text-gray-900' }}">
                                ฿{{ "{:,.2f}".format(project.actual_cost or 0) }}
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="flex justify-center space-x-2">
                                <a href="{{ url_for('procurement.mas.create_or_edit', mas_id=project.id) }}"
                                    class="btn btn-sm bg-yellow-50 hover:bg-yellow-100 text-yellow-700 border border-yellow-200 rounded-md">
                                    <i class="ph ph-pencil-simple"></i>
                                </a>
                                <button type="button"
                                    class="btn btn-sm bg-red-50 hover:bg-red-100 text-red-700 border border-red-200 rounded-md"
                                    onclick="document.getElementById('delete-mas-{{ project.id }}').showModal()">
                                    <i class="ph ph-trash"></i>
                                </button>
                            </div>

                            <!-- Delete Confirmation Modal -->
                            <dialog id="delete-mas-{{ project.id }}" class="modal">
                                <div class="modal-box bg-white rounded-lg shadow-xl border border-gray-200 p-0">
                                    <div class="p-6 border-b border-gray-200">
                                        <h3 class="text-lg font-bold text-gray-800">ยืนยันการลบโครงการ</h3>
                                    </div>
                                    <div class="p-6">
                                        <div class="bg-gray-50 border border-gray-200 rounded-md p-4 mb-4">
                                            <p class="text-sm text-gray-500 mb-1">รหัส MAS</p>
                                            <p class="font-mono font-medium text-gray-900">{{ project.mas_code }}</p>
                                        </div>
                                        <p class="text-gray-700 mb-2">คุณแน่ใจหรือไม่ที่จะลบโครงการ:</p>
                                        <p class="font-medium text-gray-900 mb-4">{{ project.name }}</p>
                                        <div class="bg-amber-50 border border-amber-200 rounded-md p-3 text-amber-800">
                                            <i class="ph ph-warning mr-2"></i>
                                            <span class="text-sm">การลบจะเปลี่ยนสถานะโครงการเป็น "ปิดบัญชี"
                                                ไม่ได้ลบออกจากฐานข้อมูล</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-end space-x-3 p-4 border-t border-gray-200 bg-gray-50">
                                        <button type="button"
                                            class="btn bg-white border-gray-300 text-gray-700 hover:bg-gray-50"
                                            onclick="document.getElementById('delete-mas-{{ project.id }}').close()">
                                            ยกเลิก
                                        </button>
                                        <form method="POST"
                                            action="{{ url_for('procurement.mas.delete', mas_id=project.id) }}">
                                            <button type="submit"
                                                class="btn bg-red-600 hover:bg-red-700 text-white border-none">
                                                ยืนยันลบ
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </dialog>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-16">
                            <div class="flex flex-col items-center">
                                <div class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mb-3">
                                    <i class="ph ph-file-x text-4xl text-gray-400"></i>
                                </div>
                                <h3 class="text-lg font-medium text-gray-700 mb-1">ไม่พบข้อมูลโครงการ</h3>
                                <p class="text-gray-500">กรุณาเพิ่มโครงการใหม่เพื่อเริ่มต้นใช้งานระบบ</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="bg-gray-50 p-4 border-t border-gray-200 text-sm text-gray-500">
            <div class="flex justify-between items-center">
                <div>
                    <span class="font-medium">แสดงทั้งหมด:</span> {{ mas|length }} รายการ
                </div>
                <div>
                    <span class="font-medium">งบประมาณรวม:</span> ฿{{ "{:,.2f}".format(budget or 0) }}
                </div>
            </div>
        </div>
    </div>
    {% endmacro %}

    {% macro render_non_renewal_items_table(disactive_items) %}
    <div class="mt-12">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-rose-600 flex items-center gap-3">
                <div class="w-10 h-10 bg-rose-100 rounded-full flex items-center justify-center">
                    <i class="ph ph-x-circle text-rose-600 text-lg"></i>
                </div>
                รายการที่ไม่ต่ออายุ
            </h3>
            <div class="bg-rose-50 border border-rose-200 rounded-full px-4 py-2">
                <span class="text-rose-700 font-semibold text-sm">{{ disactive_items|length }} รายการ</span>
            </div>
        </div>

        {% if disactive_items|length == 0 %}
        <!-- Enhanced Empty State -->
        <div
            class="bg-gradient-to-br from-rose-50 to-pink-50 rounded-2xl border-2 border-dashed border-rose-200 p-12 text-center">
            <div class="w-20 h-20 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="ph ph-check-circle text-rose-400 text-3xl"></i>
            </div>
            <h4 class="text-lg font-semibold text-rose-700 mb-2">ยังไม่มีรายการที่ไม่ต่ออายุ</h4>
            <p class="text-rose-600">ทุกรายการยังคงอยู่ในสถานะรอการดำเนินการ</p>
        </div>
        {% else %}
        <!-- Enhanced Table Layout -->
        <div class="bg-white rounded-xl shadow-sm border border-rose-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-rose-200">
                    <thead class="bg-gradient-to-r">
                        <tr>
                            <th class="text-center font-semibold text-base-content text-sm py-4">ลำดับ</th>
                            <th class="font-semibold text-base-content text-sm w-48">เลขที่เบิกจ่าย</th>
                            <th class="font-semibold text-base-content text-sm w-72">ชื่อรายการ</th>
                            <th class="font-semibold text-base-content text-sm text-center w-48">ประเภท</th>
                            <th class="font-semibold text-base-content text-sm text-center w-48">วันที่สิ้นสุด</th>
                            <th class="font-semibold text-base-content text-sm text-center">บริษัท</th>
                            <th class="font-semibold text-base-content text-sm text-center w-64">จำนวนเงิน</th>
                            <th class="font-semibold text-base-content text-sm text-center w-72">สถานะ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100">
                        {% for item in disactive_items %}
                        <tr class="hover:bg-rose-50 transition-colors duration-200">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div
                                    class="w-8 h-8 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center text-sm font-bold">
                                    {{ loop.index }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-semibold text-gray-900">{{ item.product_number }}</div>
                                <div class="text-xs text-gray-500 flex items-center gap-1">
                                    <i class="ph ph-barcode"></i>{{ item.asset_code }}
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium text-gray-900 max-w-xs truncate"
                                    title="{{ item.name }}">
                                    {{ item.name }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% set category_badge = {
                                'ซอฟต์แวร์': 'bg-blue-50 text-blue-700 border border-blue-200',
                                'ครุภัณฑ์': 'bg-amber-50 text-amber-700 border border-amber-200',
                                'จ้างเหมาบริการ': 'bg-purple-50 text-purple-700 border border-purple-200',
                                'อื่นๆ': 'bg-gray-50 text-gray-700 border border-gray-200'
                                }.get(item.get_category_display(), 'bg-gray-50 text-gray-700 border border-gray-200') %}
                                <span
                                    class="inline-flex px-3 py-1 rounded-full text-xs font-semibold {{ category_badge }}">
                                    {{ item.get_category_display() }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center gap-2">
                                    <i class="ph ph-calendar-x text-rose-500"></i>
                                    <span class="text-sm font-medium text-rose-700">
                                        {{ item.end_date.strftime('%d/%m/%Y') if item.end_date }}
                                    </span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center gap-2">
                                    <i class="ph ph-buildings text-gray-400"></i>
                                    <span class="text-sm text-gray-900">{{ item.company }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <div class="text-lg font-bold text-rose-600">
                                    ฿{{ "{:,.2f}".format(item.amount) }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <span
                                    class="inline-flex items-center gap-2 bg-rose-100 text-rose-700 px-3 py-1 rounded-full text-xs font-medium">
                                    <i class="ph ph-clock text-rose-500"></i>
                                    ไม่ต่ออายุ
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
    {% endmacro %}

    {# filepath: Untitled #}
    {% macro render_renewal_requested_items_table(renewal_requested_items) %}
    <div class="mt-12">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-blue-600 flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="ph ph-arrow-clockwise text-blue-600 text-lg"></i>
                </div>
                รายการที่ขอต่ออายุ
            </h3>
            <div class="bg-blue-50 border border-blue-200 rounded-full px-4 py-2">
                <span class="text-blue-700 font-semibold text-sm">{{ renewal_requested_items|length }} รายการ</span>
            </div>
        </div>

        {% if renewal_requested_items|length == 0 %}
        <!-- ...existing empty state code... -->
        {% else %}
        <div class="bg-white rounded-xl shadow-sm border border-blue-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-blue-200">
                    <thead class="bg-gradient-to-r">
                        <tr>
                            <th class="text-center font-semibold text-base-content text-sm py-4 w-32">เลขที่</th>
                            <th class="font-semibold text-base-content text-sm w-64">ชื่อรายการ</th>
                            <th class="font-semibold text-base-content text-sm text-center w-32">จำนวนรายการ</th>
                            <th class="font-semibold text-base-content text-sm text-center w-40">วันที่ต้องการใช้งาน
                            </th>
                            <th class="font-semibold text-base-content text-sm text-center w-40">บริษัท</th>
                            <th class="font-semibold text-base-content text-sm text-center w-32">จำนวนเงิน</th>
                            <th class="font-semibold text-base-content text-sm text-center w-24">เอกสาร</th>
                            <th class="font-semibold text-base-content text-sm text-center w-20">แก้ไข</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100">
                        {% for item in renewal_requested_items %}
                        <tr class="hover:bg-blue-50 transition-colors duration-200">
                            <td class="px-4 py-3 whitespace-nowrap text-center">
                                <div class="text-ms flex items-center gap-1 justify-center">
                                    <i class="ph ph-barcode"></i>{{ item.requisition_code }}
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <div class="text-sm font-medium text-gray-900 max-w-xs truncate"
                                    title="{{ item.items[0].product_name if item.items }}">
                                    {{ item.items[0].product_name if item.items else '-' }}
                                </div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-center">
                                <span
                                    class="inline-flex px-3 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700 border border-blue-200">
                                    {{ item.items|length }} รายการ
                                </span>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-center">
                                <div class="flex items-center gap-2 justify-center">
                                    <i class="ph ph-calendar-x text-blue-500"></i>
                                    <span class="text-sm font-medium text-blue-700">
                                        {{ item.start_date.strftime('%d/%m/%Y') if item.start_date }}
                                    </span>
                                </div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-center">
                                <div class="flex items-center gap-2 justify-left">
                                    <i class="ph ph-buildings text-gray-400"></i>
                                    <span class="text-sm text-gray-900">
                                        {{ item.items[0].company if item.items else '-' }}
                                    </span>
                                </div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-right">
                                <div class="text-lg font-bold text-blue-600">
                                    ฿{{ "{:,.2f}".format(item.items[0].amount) if item.items else '0.00' }}
                                </div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-center">
                                <a href="{{ url_for('procurement.requisitions.document', requisition_procurement_id=item.id) }}"
                                    class="btn btn-outline btn-sm text-blue-700 border-blue-300 hover:bg-blue-50"
                                    target="_blank">
                                    <i class="ph ph-file-arrow-down"></i> ดูเอกสาร
                                </a>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-center">
                                <a href="{{ url_for('procurement.requisitions.create_or_edit', requisition_procurement_id=item.id) }}"
                                    class="btn btn-outline btn-sm text-yellow-700 border-yellow-300 hover:bg-yellow-50">
                                    <i class="ph ph-pencil-simple-line"></i> แก้ไข
                                </a>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="8" class="bg-blue-50 px-4 py-2">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-blue-100">
                                        <thead>
                                            <tr>
                                                <th class="text-center text-xs font-semibold py-2">ชื่อรายการ</th>
                                                <th class="text-center text-xs font-semibold py-2">ประเภท</th>
                                                <th class="text-center text-xs font-semibold py-2">จำนวน</th>
                                                <th class="text-center text-xs font-semibold py-2">บริษัท</th>
                                                <th class="text-center text-xs font-semibold py-2">จำนวนเงิน</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for subitem in item.items %}
                                            <tr>
                                                <td class="text-sm px-2 py-1 text-center">{{ subitem.product_name }}
                                                </td>
                                                <td class="text-sm px-2 py-1 text-center">{{
                                                    subitem.get_category_display() }}</td>
                                                <td class="text-sm px-2 py-1 text-center">{{ subitem.quantity }}</td>
                                                <td class="text-sm px-2 py-1 text-center">{{ subitem.company }}</td>
                                                <td class="text-sm px-2 py-1 text-right">฿{{
                                                    "{:,.2f}".format(subitem.amount) }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
    {% endmacro %}